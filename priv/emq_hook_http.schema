%%%--------------------------------------------------------------------------------
%% The MIT License (MIT)
%%
%% Copyright (c) 2017 LiangMaYong
%%
%% Permission is hereby granted, free of charge, to any person obtaining a copy
%% of this software and associated documentation files (the "Software"), to deal
%% in the Software without restriction, including without limitation the rights
%% to use, copy, modify, merge, publish, distribute, sublicense, and/ or sell
%% copies of the Software, and to permit persons to whom the Software is
%% furnished to do so, subject to the following conditions:
%%
%% The above copyright notice and this permission notice shall be included in all
%% copies or substantial portions of the Software.
%%
%% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
%% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
%% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
%% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
%% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
%% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
%% SOFTWARE.
%%%--------------------------------------------------------------------------------

%%%---------------------------------------------------
%% HOOK
%%%---------------------------------------------------


{mapping, "emq.hook.http.hook_req", "emq_hook_http.hook_req", [
  {default, undefined},
  {datatype, string}
]}.

{mapping, "emq.hook.http.hook_req.method", "emq_hook_http.hook_req", [
  {default, post},
  {datatype, {enum, [post, get]}}
]}.

{mapping, "emq.hook.http.hook_req.params", "emq_hook_http.hook_req", [
  {datatype, string}
]}.

{mapping, "emq.hook.http.hook_req.appkey", "emq_hook_http.hook_req", [
  {datatype, string}
]}.

{translation, "emq_hook_http.hook_req", fun(Conf) ->
  case cuttlefish:conf_get("emq.hook.http.hook_req", Conf, undefined) of
    undefined -> cuttlefish:unset();
    Url -> Params = cuttlefish:conf_get("emq.hook.http.hook_req.params", Conf),
           [{url, Url}, {method, cuttlefish:conf_get("emq.hook.http.hook_req.method", Conf)},
            {appkey, cuttlefish:conf_get("emq.hook.http.hook_req.appkey", Conf)},
            {params, [list_to_tuple(string:tokens(S, "=")) || S <- string:tokens(Params, ",")]}]
  end
end}.

%%%---------------------------------------------------
%% AUTH
%%%---------------------------------------------------

{mapping, "emq.hook.http.auth_req", "emq_hook_http.auth_req", [
  {default, undefined},
  {datatype, string}
]}.

{mapping, "emq.hook.http.auth_req.method", "emq_hook_http.auth_req", [
  {default, post},
  {datatype, {enum, [post, get]}}
]}.

{mapping, "emq.hook.http.auth_req.params", "emq_hook_http.auth_req", [
  {datatype, string}
]}.

{mapping, "emq.hook.http.auth_req.appkey", "emq_hook_http.auth_req", [
  {datatype, string}
]}.

{translation, "emq_hook_http.auth_req", fun(Conf) ->
  case cuttlefish:conf_get("emq.hook.http.auth_req", Conf, undefined) of
    undefined -> cuttlefish:unset();
    Url -> Params = cuttlefish:conf_get("emq.hook.http.auth_req.params", Conf),
           [{url, Url}, {method, cuttlefish:conf_get("emq.hook.http.auth_req.method", Conf)},
            {appkey, cuttlefish:conf_get("emq.hook.http.auth_req.appkey", Conf)},
            {params, [list_to_tuple(string:tokens(S, "=")) || S <- string:tokens(Params, ",")]}]
  end
end}.